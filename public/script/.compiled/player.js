// Generated by CoffeeScript 1.7.1
(function() {
  var Player;

  window.Player = Player = (function() {
    Player.prototype.codec = null;

    Player.prototype.audio = $('audio')[0];

    Player.prototype._nextAudio = null;

    Player.prototype._timeToStart = store.get('gapless') || 0;

    Player.prototype._curplaying = {
      trackId: null,
      length: 1,
      start: 0
    };

    Player.prototype._bufstart = null;

    Player.prototype._draggingseekbar = false;


    /*
     */

    function Player() {
      this.initVolume();
      this.initSeekbar();
      this.initMouse();
      this.initPlayer();
    }


    /*
     */

    Player.prototype.initMouse = function() {
      var my;
      my = this;
      $('#player').on('click', '.settings', window.showSettings);
      $('#player').on('click', '.play', function(e) {
        var active;
        if (isNaN(my.audio.duration)) {
          active = $('#playlist .active');
          if (active.length > 0) {
            return window.playlist.playRow(active);
          }
          return window.playlist.playRow($('#playlist tbody tr:eq(0)'));
        }
        return my.audio.play();
      });
      $('#player').on('click', '.pause', function(e) {
        return my.audio.pause();
      });
      $('#player').on('click', '.forward', function(e) {
        return my.playNext();
      });
      $('#player').on('click', '.backward', function(e) {
        return my.playPrev();
      });
      return $('#player').on('click', '.stop', function(e) {
        return my.stop();
      });
    };


    /*
     */

    Player.prototype.initVolume = function() {
      var my;
      my = this;
      window.vol = new Slider({
        target: $('#player .volume'),
        move: function(pos) {
          my.setVol(pos);
          return Math.round(pos);
        }
      });
      if (store.get('volume') !== null) {
        return my.setVol(store.get('volume'));
      } else {
        return my.setVol(50);
      }
    };


    /*
     */

    Player.prototype.initSeekbar = function() {
      var my;
      my = this;
      return this.seekbar = new window.Slider({
        target: $('#player .seekbar'),
        start: function() {
          return my._draggingseekbar = true;
        },
        move: function(pos) {
          var v;
          v = my._curplaying.length / 100 * pos;
          my.audio.currentTime = v;
          return displaytime(v);
        },
        stop: function() {
          return my._draggingseekbar = false;
        }
      });
    };


    /*
     */

    Player.prototype.initPlayer = function(audio) {
      var my;
      if (audio == null) {
        audio = null;
      }
      if (!audio) {
        audio = this.audio;
      }
      my = this;
      $(audio).bind('play', function() {
        if (!$(this).hasClass('active')) {
          return;
        }
        $('#player').attr('class', 'right-of-library playing');
        return $('#playlist .playing .icon-pause').attr('class', 'icon-play');
      });
      $(audio).bind('pause', function() {
        if (!$(this).hasClass('active')) {
          return;
        }
        $('#player').attr('class', 'right-of-library paused');
        $('#playlist .playing .icon-play').attr('class', 'icon-pause');
        return $('#status span:eq(0)').html('Paused');
      });
      $(audio).bind('ended', function() {
        var album, artist, track, _ref;
        if (!$(this).hasClass('active')) {
          return;
        }
        $('.seekbar .buffer').css('width', '0px');
        my._bufstart = null;
        if (my._curplaying.length > 30) {
          _ref = window.info.getInfo(my._curplaying.trackId), track = _ref[0], album = _ref[1], artist = _ref[2];
          if (track) {
            window.scrobble.scrobble({
              timestamp: my._curplaying.start,
              artist: artist.name,
              album: album.name,
              track: track.name,
              trackNumber: track.trackno,
              duration: track.length
            });
          }
        }
        if (!my.playNext()) {
          return my.stop();
        }
      });
      $(audio).bind('timeupdate', function(e) {
        var next, t, v;
        if (!$(this).hasClass('active')) {
          return;
        }
        if (my._draggingseekbar) {
          return;
        }
        v = Math.min(100, my.audio.currentTime / my._curplaying.length * 100);
        my.seekbar.setpos(v);
        if (!my._timeToStart && (my._start != null) && v > 0) {
          my._timeToStart = (Date.now() - my._start) / 1000;
          my._start = void 0;
          dbg('Player', 'Set @_timeToStart to', my._timeToStart);
        }
        t = displaytime(my.audio.currentTime);
        $('#status span:eq(0)').html('Playing');
        $('#status span:eq(1)').html("" + t + " / " + (displaytime(my._curplaying.length)));
        if (my._nextAudio === null && my._curplaying.length - my.audio.currentTime < 10) {
          next = $('#playlist .playing').next();
          if ((next != null) && (next.attr('data-id') != null)) {
            dbg('Player', 'preparing _nextAudio');
            my._nextAudio = {
              audio: document.createElement('audio'),
              id: next.attr('data-id')
            };
            my._nextAudio.audio.preload = 'auto';
            my._nextAudio.audio.src = "" + _root + "/play-track/" + (store.get('client')) + "/" + my.codec + "/" + (next.attr('data-id'));
            $(my.audio).after(my._nextAudio.audio);
            my.initPlayer(my._nextAudio.audio);
          }
        }
        if (my._nextAudio && my._curplaying.length - my.audio.currentTime < (my._timeToStart || .2)) {
          log(my._curplaying.length, my.audio.currentTime, my._curplaying.length - my.audio.currentTime);
          dbg('Player', 'Playing _nextAudio');
          my.setVol(null, my._nextAudio.audio);
          return my._nextAudio.audio.play();
        }
      });
      return $(audio).bind('progress', function(e) {
        var c, dur, exc, r;
        if (!$(this).hasClass('active')) {
          return;
        }
        try {
          c = Math.min(100, Math.round(my.audio.buffered.end(0) / my._curplaying.length * 100));
        } catch (_error) {
          exc = _error;
          return;
        }
        if (c === 100) {
          $('#status span:eq(2)').html("Buffer " + c + "%");
          return $('.seekbar .buffer').css('width', "" + c + "%");
        } else {
          if (!my.bufstart) {
            my.bufstart = new Date().getTime() / 1000;
            return;
          }
          dur = new Date().getTime() / 1000 - my.bufstart;
          r = (dur / c) * (100 - c);
          $('#status span:eq(2)').html("Buffer " + c + "% (~" + (displaytime(Math.round(r))) + "s remaining)");
          return $('.seekbar .buffer').css('width', "" + c + "%");
        }
      });
    };

    Player.prototype.playStream = function() {
      this.audio.src = '/stream_path/%2Fdata%2Fmusic%2FAyreon%2F1998%20Into%20the%20Electric%20Castle%2F2.06%20The%20Mirror%20Maze_%20A%29%20Inside%20the%20Mirror%20Maze%20-%20B%29%20Through%20the%20Mirror.flac';
      this.audio.play();
      return $(this.audio).trigger('progress');
    };


    /*
    	Play audio file `trackId` of `length` seconds
     */

    Player.prototype.play = function(trackId, length) {
      var album, artist, row, track, _ref;
      if (this.codec === null) {
        return alert("Your browser doesn't seem to support either Ogg/Vorbis or MP3 playback");
      }
      this.bufstart = null;
      if ((this._nextAudio != null) && trackId !== this._nextAudio.id) {
        $(this._nextAudio.audio).remove();
        this._nextAudio = null;
      } else if (this._nextAudio != null) {
        this.audio.remove();
        this.audio = this._nextAudio.audio;
        this._nextAudio = null;
        this.audio.className = 'active';
      } else {
        this.audio.pause();
        this.audio.src = '';
        this.audio.src = "" + _root + "/play-track/" + (store.get('client')) + "/" + this.codec + "/" + trackId;
      }
      this._curplaying = {
        trackId: trackId,
        length: parseFloat(length),
        start: (new Date().getTime() / 1000).toNum() + new Date().getTimezoneOffset()
      };
      this.setVol();
      if (!(this._timeToStart > 0)) {
        this._start = Date.now();
      }
      this.audio.play();
      $(this.audio).trigger('progress');
      row = $("#playlist tr[data-id=" + trackId + "]");
      $('#playlist tr').removeClass('playing');
      row.addClass('playing').find('td:eq(0)').html('<i class="icon-play"></i>');
      store.set('lasttrack', trackId);
      _ref = window.info.getInfo(trackId), track = _ref[0], album = _ref[1], artist = _ref[2];
      if (track) {
        return window.scrobble.nowPlaying({
          artist: artist.name,
          album: album.name,
          track: track.name,
          trackNumber: track.trackno,
          duration: track.length
        });
      }
    };


    /*
    	Try and play the next track
     */

    Player.prototype.playNext = function(prev) {
      var n;
      if (prev == null) {
        prev = false;
      }
      n = prev ? $('#playlist .playing').prev() : $('#playlist .playing').next();
      $('#playlist .playing').removeClass('playing');
      if (n.length > 0) {
        window.playlist.playRow(n);
        return true;
      } else {
        return false;
      }
    };


    /*
    	Try and play the previous track
     */

    Player.prototype.playPrev = function() {
      return this.playNext(true);
    };


    /*
    	Stop playing
     */

    Player.prototype.stop = function() {
      $('.seekbar .buffer').css('width', '0px');
      this.audio.pause();
      $('#playlist tr').removeClass('playing');
      this.audio.src = '';
      $('#player').attr('class', 'right-of-library stopped');
      store.set('lasttrack', null);
      this._bufstart = null;
      (function() {
        $('#status span').html('');
        return $('#status span:eq(0)').html('Stopped');
      }).timeout(150);
      if (this._nextAudio != null) {
        $(this._nextAudio.audio).remove();
        return this._nextAudio = null;
      }
    };


    /*
    	Set volume in percentage (0-100) & adjust for replaygain
    	If the volume is null, we'll set it to the current volume, but re-apply
    	replaygain (do this when switching tracks)
     */

    Player.prototype.setVol = function(v, audio) {
      var apply, rg, scale, _ref, _ref1, _ref2;
      if (v == null) {
        v = null;
      }
      if (audio == null) {
        audio = null;
      }
      if (audio == null) {
        audio = this.audio;
      }
      if (v == null) {
        v = store.get('volume');
      }
      store.set('volume', v);
      scale = 1;
      if (this._curplaying.trackId) {
        rg = false;
        apply = store.get('replaygain');
        if (apply === 'album') {
          rg = (_ref = window._cache.albums[(_ref1 = window._cache.tracks[this._curplaying.trackId]) != null ? _ref1.album : void 0]) != null ? _ref.rg_gain : void 0;
        } else if (apply === 'track') {
          rg = (_ref2 = window._cache.tracks[this._curplaying.trackId]) != null ? _ref2.rg_gain : void 0;
        }
      }
      if (rg == null) {
        rg = store.get('last_rg');
      }
      if (rg) {
        store.set('last_rg', rg);
        scale = Math.pow(10, rg / 20);
      }
      dbg('Player', "Setting volume to " + v + ", " + rg + ", " + scale);
      audio.volume = Math.min(1, v * scale / 100);
      return window.vol.setpos(store.get('volume'));
    };

    return Player;

  })();

}).call(this);
